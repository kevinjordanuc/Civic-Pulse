import os
import sys
# Forzamos la codificación a utf-8 para evitar errores de impresión en Windows
sys.stdout.reconfigure(encoding='utf-8')

from dotenv import load_dotenv
from openai import AzureOpenAI
from azure.core.credentials import AzureKeyCredential
from azure.search.documents.indexes import SearchIndexClient
from azure.storage.blob import BlobServiceClient
from azure.cosmos import CosmosClient

# Cargar variables
load_dotenv()

print("==========================================")
print("  TEST DE CONEXION (SIN EMOJIS)  ")
print("==========================================\n")

def test_openai():
    print("1. Azure OpenAI...", end=" ")
    try:
        client = AzureOpenAI(
            azure_endpoint=os.getenv("AZURE_OPENAI_ENDPOINT"),
            api_key=os.getenv("AZURE_OPENAI_API_KEY"),
            api_version=os.getenv("AZURE_OPENAI_API_VERSION")
        )
        response = client.chat.completions.create(
            model=os.getenv("AZURE_OPENAI_MODEL"),
            messages=[{"role": "user", "content": "Hola"}],
            max_tokens=5
        )
        print("[ OK ]")
    except Exception as e:
        print("[ ERROR ]")
        print(f"   >>> {e}")

def test_search():
    print("2. Azure AI Search...", end=" ")
    try:
        endpoint = os.getenv("AZURE_SEARCH_ENDPOINT")
        key = os.getenv("AZURE_SEARCH_KEY")
        client = SearchIndexClient(endpoint=endpoint, credential=AzureKeyCredential(key))
        list(client.list_indexes())
        print("[ OK ]")
    except Exception as e:
        print("[ ERROR ]")
        print(f"   >>> {e}")

def test_storage():
    print("3. Azure Storage...", end=" ")
    try:
        conn_str = os.getenv("AZURE_BLOB_CONNSTR")
        blob_service_client = BlobServiceClient.from_connection_string(conn_str)
        list(blob_service_client.list_containers())
        print("[ OK ]")
    except Exception as e:
        print("[ ERROR ]")
        print(f"   >>> {e}")

def test_cosmos():
    print("4. Cosmos DB...", end=" ")
    try:
        conn_str = os.getenv("COSMOSDB_CONNSTR")
        client = CosmosClient.from_connection_string(conn_str)
        list(client.list_databases())
        print("[ OK ]")
    except Exception as e:
        print("[ ERROR ]")
        print(f"   >>> {e}")

def test_app_insights():
    print("5. App Insights...", end=" ")
    conn = os.getenv("APPINSIGHTS_CONNECTION_STRING")
    if conn and "InstrumentationKey=" in conn:
        print("[ OK ] (Formato valido)")
    else:
        print("[ ERROR ] Formato invalido")

if __name__ == "__main__":
    test_openai()
    test_search()
    test_storage()
    test_cosmos()
    test_app_insights()
    print("\n==========================================")